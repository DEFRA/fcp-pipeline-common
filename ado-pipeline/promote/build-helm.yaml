steps:
  - script: |
      echo "Checking Helm Chart..."
      ls -la
      env | grep -i "BUILD_REPOSITORY" | sort
    displayName: "Build Helm"

  # Check if Helm is installed and print version
  - script: |
      if ! command -v helm &> /dev/null; then
        echo "Helm is not installed. Please install Helm to proceed."
        exit 1
      fi
      helm version --short
    displayName: "Check Helm Installation"

  # Check if the Helm chart directory exists
  - script: |
      REPO_NAME=$(echo "$BUILD_REPOSITORY_NAME" | cut -d'/' -f2)
      echo "Repository Name: $REPO_NAME"

      HELM_CHART_PATH="$(Agent.BuildDirectory)/s/$REPO_NAME/helm/$REPO_NAME"
      echo "Helm Chart Path: $HELM_CHART_PATH"

      cd "$HELM_CHART_PATH"

      if [ -f "Chart.yaml" ]; then
        echo "Chart.yaml file exists."
        helm dependency update
        helm lint .

        # Template the chart to see what gets rendered
        helm template "$REPO_NAME" .
      else
        echo "Chart.yaml file does not exist"
        ls -la
        exit 1
      fi
    displayName: "Check Helm Chart Directory"

  # Package and push the Helm chart to ACR
  - script: |

      REPO_NAME=$(echo "$BUILD_REPOSITORY_NAME" | cut -d'/' -f2)
      echo "Repo Name: $REPO_NAME"

      HELM_CHART_PATH="$(Agent.BuildDirectory)/s/$REPO_NAME/helm/$REPO_NAME"
      echo "Helm Chart Path: $HELM_CHART_PATH"

      cd "$HELM_CHART_PATH"

      echo "Logging into ACR..."
      az acr login --name $(sharedAcr)

      echo "Packaging Helm chart with version: $(releaseVersion)"
      helm package . --version $(releaseVersion) --app-version $(releaseVersion)


      CHART_PACKAGE="${REPO_NAME}-$(releaseVersion).tgz"
      echo "Chart Package: $CHART_PACKAGE"

      echo "Logging into ACR registry: $(sharedAcr).azurecr.io"
      az acr login --name $(sharedAcr)
      helm registry login $(sharedAcr).azurecr.io

      echo "Pushing Helm chart to ACR..."
      helm push "$CHART_PACKAGE" oci://$(sharedAcr).azurecr.io/helm

      echo "Helm chart $CHART_PACKAGE pushed to oci://$(sharedAcr).azurecr.io/helm"
    displayName: "Package & Push Helm Chart to ACR"
