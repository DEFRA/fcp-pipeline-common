parameters:
  - name: appFrameworkType
    type: string
    default: nodejs
  - name: type
    type: string
    default: kubernetes # kubernetes, npm, functions, nuget etc.
  - name: npmLegacyPeerDeps
    type: boolean
    default: false
  - name: dockerFilePath
    type: string
    default: Dockerfile
  - name: testDockerComposeFile
    type: string
    default: docker-compose.test.yaml
  - name: failOnThreshold
    type: string
    default: moderate

  - name: prDeployment
    type: boolean
    default: false
  - name: branchDeployment
    type: boolean
    default: false
  - name: snd1Deployment
    type: boolean
    default: false
  - name: sndDeployment
    type: boolean
    default: true
  - name: variableGroupName
    type: string
    default: ''
  - name: pr_params
    type: object
    default: {}
  - name: snd2_params
    type: object
    default: {}
  - name: dev_params
    type: object
    default: {}
  - name: test_params
    type: object
    default: {}
  - name: pre_params
    type: object
    default: {}
  - name: prd_params
    type: object
    default: {}

  - name: enableServiceNowChangeCreation
    type: boolean
    default: false

  - name: enableServiceNowChangeCreationDev
    type: boolean
    default: false

  - name: deployVersion
    type: string
    default: ''

resources:
  repositories:
    - repository: FcpPipelineCommon
      name: defra/fcp-pipeline-common
      endpoint: DEFRA-ADP
      type: github
      ref: refs/heads/pl-983

variables:
  - ${{ if ne(parameters.variableGroupName, '') }}:
      - group: ${{ parameters.variableGroupName }}
  - group: fcp-pipeline-common-variables
  - group: fcp-pipeline-common-secrets
  - name: appName
    value: $[replace(variables['Build.Repository.Name'], 'DEFRA/', '')]
  - name: isPackage
    value: ${{ or(eq(parameters.type, 'npm'), eq(parameters.type, 'nuget')) }}
  - name: isMainBranch
    value: ${{ eq(variables['Build.SourceBranch'], 'refs/heads/main') }}
  # PR runs
  - ${{ if eq(variables['Build.Reason'], 'PullRequest') }}:
      - name: branchRef
        value: $[variables['System.PullRequest.SourceBranch']] # e.g. refs/heads/feature/foo
      - name: prNumber
        value: $[variables['System.PullRequest.PullRequestNumber']]
      - name: isPr
        value: true

  # Non-PR runs
  - ${{ if ne(variables['Build.Reason'], 'PullRequest') }}:
      - name: branchRef
        value: $[variables['Build.SourceBranch']] # e.g. refs/heads/main
      - name: prNumber
        value: ''
      - name: isPr
        value: false

  # Derived once from branchRef
  - name: branchName
    value: $[replace(variables['branchRef'], 'refs/heads/', '')]

stages:
  - stage: Build
    displayName: 'Build'
    jobs:
      - job: InitAndBuild
        displayName: 'Build Application'

        steps:
          - checkout: self
            fetchDepth: 0
          - checkout: FcpPipelineCommon

          - script: |
              echo "##[section]Primary repository: $BUILD_REPOSITORY_NAME"
              echo "##[section]Branch: $(branchName)"
              echo "##[section]Commit message: $BUILD_SOURCEVERSIONMESSAGE"
              echo "##[section]Is Main Branch: $(isMainBranch)"
              echo "##[section]Is Pull Request: $(isPr)"
              echo "##[section]Pull Request Number: $(prNumber)"

            displayName: 'Build and Workspace Info'

          - template: /ado-pipeline/build/helpers/app-version.yaml
            parameters:
              appFrameworkType: ${{ parameters.appFrameworkType }}

          - template: /ado-pipeline/build/build-${{ parameters.appFrameworkType }}.yaml
            parameters:
              npmLegacyPeerDeps: ${{ parameters.npmLegacyPeerDeps }}
              failOnThreshold: ${{ parameters.failOnThreshold }}

  - stage: Promote
    displayName: 'Promote'
    dependsOn: Build
    variables:
      - template: variables.yaml
    jobs:
      - job: SnykScanApplication
        displayName: Snyk Application Scan
        steps:
          - checkout: self
          - checkout: FcpPipelineCommon
          - template: /ado-pipeline/promote/snyk-scan-application.yaml
            parameters:
              appFrameworkType: ${{ parameters.appFrameworkType }}

      - ${{ if ne(variables['isPackage'], true) }}:
          - job: HelmTemplate
            displayName: 'Build Helm Template'
            steps:
              - checkout: self
              - checkout: FcpPipelineCommon

              - template: /ado-pipeline/promote/build-helm.yaml
                parameters:
                  subscription: $(SubscriptionSND2)
                  acrName: $(AcrSND)

              - ${{ if eq(variables['isMainBranch'], True) }}:
                  - template: /ado-pipeline/promote/build-helm.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      acrName: $(AcrDEV)

                  - template: /ado-pipeline/promote/build-helm.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                      acrName: $(AcrPRE)

                  - template: /ado-pipeline/promote/build-helm.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                      acrName: $(AcrPRD)

          - job: DockerBuild
            displayName: 'Docker Build'
            steps:
              - checkout: self
              - checkout: FcpPipelineCommon

              - template: /ado-pipeline/promote/docker-build.yaml
                parameters:
                  dockerFilePath: ${{ parameters.dockerFilePath }}
                  subscription: $(SubscriptionSND2)
                  acrName: $(AcrSND)

              - ${{ if eq(variables['isMainBranch'], True) }}:
                  - template: /ado-pipeline/promote/docker-build.yaml
                    parameters:
                      dockerFilePath: ${{ parameters.dockerFilePath }}
                      subscription: $(SubscriptionDEV)
                      acrName: $(AcrDEV)

                  - template: /ado-pipeline/promote/docker-build.yaml
                    parameters:
                      dockerFilePath: ${{ parameters.dockerFilePath }}
                      subscription: $(SubscriptionPRE)
                      acrName: $(AcrPRE)

                  - template: /ado-pipeline/promote/docker-build.yaml
                    parameters:
                      dockerFilePath: ${{ parameters.dockerFilePath }}
                      subscription: $(SubscriptionPRD)
                      acrName: $(AcrPRD)

          - job: TestsDockerCompose
            displayName: Tests With Docker Compose
            dependsOn: DockerBuild
            condition: succeeded()
            steps:
              - checkout: self
              - checkout: FcpPipelineCommon
              - template: /ado-pipeline/promote/tests-docker-compose.yaml
                parameters:
                  testDockerComposeFile: ${{ parameters.testDockerComposeFile }}
                  subscription: $(sharedSubscription)

          - job: SonarCloud
            displayName: SonarCloud Analysis
            dependsOn: TestsDockerCompose
            steps:
              - checkout: self
              - checkout: FcpPipelineCommon
              - template: /ado-pipeline/promote/sonar-cloud.yaml
                parameters:
                  appFrameworkType: ${{ parameters.appFrameworkType }}

      - ${{ else }}:
          - job: SonarCloud
            displayName: SonarCloud Analysis
            steps:
              - checkout: self
              - checkout: FcpPipelineCommon
              - template: /ado-pipeline/promote/sonar-cloud.yaml
                parameters:
                  appFrameworkType: ${{ parameters.appFrameworkType }}
                  downloadArtifact: False

      - ${{ if eq(variables['isMainBranch'], True) }}:
          - job: Tagging
            condition: succeeded()
            displayName: Tagging the Repository
            steps:
              - checkout: self
                fetchDepth: 0
              - bash: |
                  set -euo pipefail

                  APP_VERSION=$(releaseVersion)
                  echo "##[debug]Tagging the repository with version $APP_VERSION"

                  echo "##[debug]Setting the git origin url with PAT for tagging"
                  GITHUB_PAT=$(ffcplatform-github-user-pat)

                  git config --global user.email "ffcplatform@defra.gov.uk"
                  git config --global user.name "ffcplatform"

                  git remote set-url origin "https://x-access-token:$GITHUB_PAT@github.com/DEFRA/$(appName).git"

                  echo "##[debug]Fetching tags from origin"
                  git fetch --tags origin

                  # Check if the tag already exists on REMOTE (more accurate than local-only)
                  if git ls-remote --tags origin "refs/tags/$APP_VERSION" | grep -q .; then
                    echo "Tag $APP_VERSION already exists on origin. Skipping."
                    exit 0
                  fi

                  git checkout main
                  git pull --ff-only origin main

                  git tag $APP_VERSION
                  git push origin refs/tags/$APP_VERSION --force
                displayName: 'Tag Repository'

  - ${{ if eq(variables['isPackage'], true) }}:
      - stage: PackageDeployment
        condition: succeeded()
        dependsOn:
          - Build
        displayName: Package Deployment
        variables:
          - template: variables.yaml

        jobs:
          - job: Deploy
            displayName: Deploy
            condition: succeeded()
            steps:
              - checkout: self
              - checkout: FcpPipelineCommon
              - template: /ado-pipeline/packageDeploy/deploy-${{ parameters.type }}.yaml

  - ${{ else }}:
      - ${{ if eq(variables['isMainBranch'], False) }}:
          - ${{ if or( and(eq(variables['isPr'], True), eq(parameters.prDeployment, True)) , and(ne(variables['isPr'], True), eq(parameters.branchDeployment, True))) }}:
              - stage: BetaDeployment
                variables:
                  - template: variables.yaml
                  - group: fcp-pipeline-snd2-variables
                pool:
                  name: DEFRA-FFC-SND2-ubuntu2204
                  condition: succeeded()
                dependsOn:
                  - Build
                  - Promote
                displayName: Beta Deployment

                jobs:
                  - job: provisioning
                    displayName: Provisioning
                    condition: succeeded()
                    steps:
                      - checkout: self
                      - checkout: FcpPipelineCommon
                      - template: /ado-pipeline/provision/resources-provisioning.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: true
                      - template: /ado-pipeline/provision/database-check.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                      - template: /ado-pipeline/provision/database-provisioning.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: true
                          databaseName: $(DbCheck.databaseName)
                          identityName: $(resourceProvisioning.identityName)
                      - template: /ado-pipeline/provision/database-migration.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: true
                          databaseName: $(DbCheck.databaseName)
                      - template: /ado-pipeline/provision/database-privileges.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: true
                          databaseName: $(DbCheck.databaseName)
                          identityName: $(resourceProvisioning.identityName)
                      - template: /ado-pipeline/provision/keyvault-access.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          identityName: $(resourceProvisioning.identityName)
                  - deployment: TempDeploy
                    variables:
                      - name: identityName
                        value: $[ dependencies.provisioning.outputs['resourceProvisioning.identityName'] ]
                      - name: identityClientId
                        value: $[ dependencies.provisioning.outputs['resourceProvisioning.identityClientId'] ]
                      - name: identityResourceId
                        value: $[ dependencies.provisioning.outputs['resourceProvisioning.identityResourceId'] ]
                      - name: databaseName
                        value: $[ dependencies.provisioning.outputs['DbCheck.databaseName'] ]
                    displayName: Deploy
                    environment: SND2-TEMP
                    dependsOn: provisioning
                    condition: succeeded()
                    workspace:
                      clean: all
                    strategy:
                      runOnce:
                        deploy:
                          steps:
                            - checkout: self
                            - checkout: FcpPipelineCommon
                            - template: /ado-pipeline/Deploy/deploy.yaml
                              parameters:
                                env: pr
                                subscription: $(SubscriptionSND2)
                                acr: $(AcrSND)
                                isTemporary: true
                                helm_params: ${{ parameters.pr_params }}

          - ${{ if eq(parameters.snd1Deployment, True) }}:
              - stage: SND1Deployment
                variables:
                  - template: variables.yaml
                  - group: fcp-pipeline-snd1-variables
                pool:
                  name: DEFRA-FFC-SND2-ubuntu2204
                  condition: succeeded()
                dependsOn:
                  - Build
                  - Promote
                displayName: SND1 Deployment

                jobs:
                  - job: provisioning
                    displayName: Provisioning
                    condition: succeeded()
                    steps:
                      - checkout: self
                      - checkout: FcpPipelineCommon
                      - template: /ado-pipeline/provision/resources-provisioning.yaml
                        parameters:
                          subscription: $(SubscriptionSND1)
                          isTemporary: true
                      - template: /ado-pipeline/provision/database-check.yaml
                        parameters:
                          subscription: $(SubscriptionSND1)
                      - template: /ado-pipeline/provision/database-provisioning.yaml
                        parameters:
                          subscription: $(SubscriptionSND1)
                          isTemporary: true
                          databaseName: $(DbCheck.databaseName)
                          identityName: $(resourceProvisioning.identityName)
                      - template: /ado-pipeline/provision/database-migration.yaml
                        parameters:
                          subscription: $(SubscriptionSND1)
                          isTemporary: true
                          databaseName: $(DbCheck.databaseName)
                      - template: /ado-pipeline/provision/database-privileges.yaml
                        parameters:
                          subscription: $(SubscriptionSND1)
                          isTemporary: true
                          databaseName: $(DbCheck.databaseName)
                          identityName: $(resourceProvisioning.identityName)
                      - template: /ado-pipeline/provision/keyvault-access.yaml
                        parameters:
                          subscription: $(SubscriptionSND1)
                          identityName: $(resourceProvisioning.identityName)
                  - deployment: SND1Deploy
                    variables:
                      - name: identityName
                        value: $[ dependencies.provisioning.outputs['resourceProvisioning.identityName'] ]
                      - name: identityClientId
                        value: $[ dependencies.provisioning.outputs['resourceProvisioning.identityClientId'] ]
                      - name: identityResourceId
                        value: $[ dependencies.provisioning.outputs['resourceProvisioning.identityResourceId'] ]
                      - name: databaseName
                        value: $[ dependencies.provisioning.outputs['DbCheck.databaseName'] ]
                    displayName: Deploy
                    environment: SND2-TEMP
                    dependsOn: provisioning
                    condition: succeeded()
                    workspace:
                      clean: all
                    strategy:
                      runOnce:
                        deploy:
                          steps:
                            - checkout: self
                            - checkout: FcpPipelineCommon
                            - template: /ado-pipeline/Deploy/deploy.yaml
                              parameters:
                                env: pr
                                subscription: $(SubscriptionSND1)
                                acr: $(AcrSND)
                                isTemporary: true
                                helm_params: ${{ parameters.pr_params }}

      - ${{ else }}:
          - ${{ if eq(parameters.sndDeployment, true) }}:
              - stage: DeploymentSND2
                variables:
                  - template: variables.yaml
                  - group: fcp-pipeline-snd2-variables
                pool:
                  name: DEFRA-FFC-SND2-ubuntu2204
                  condition: succeeded()
                dependsOn:
                  - Build
                  - Promote
                displayName: SND2 Deployment

                jobs:
                  - job: provisioningSND2
                    displayName: Provisioning SND2
                    condition: succeeded()
                    steps:
                      - checkout: self
                      - checkout: FcpPipelineCommon
                      - template: /ado-pipeline/provision/resources-provisioning.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: false
                      - template: /ado-pipeline/provision/database-check.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                      - template: /ado-pipeline/provision/database-provisioning.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: false
                          databaseName: $(DbCheck.databaseName)
                          identityName: $(resourceProvisioning.identityName)
                      - template: /ado-pipeline/provision/database-migration.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: false
                          databaseName: $(DbCheck.databaseName)
                      - template: /ado-pipeline/provision/database-privileges.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          isTemporary: false
                          databaseName: $(DbCheck.databaseName)
                          identityName: $(resourceProvisioning.identityName)
                      - template: /ado-pipeline/provision/keyvault-access.yaml
                        parameters:
                          subscription: $(SubscriptionSND2)
                          identityName: $(resourceProvisioning.identityName)

                  - deployment: DeploySND2
                    variables:
                      - name: identityName
                        value: $[ dependencies.provisioningSND2.outputs['resourceProvisioning.identityName'] ]
                      - name: identityClientId
                        value: $[ dependencies.provisioningSND2.outputs['resourceProvisioning.identityClientId'] ]
                      - name: identityResourceId
                        value: $[ dependencies.provisioningSND2.outputs['resourceProvisioning.identityResourceId'] ]
                      - name: databaseName
                        value: $[ dependencies.provisioningSND2.outputs['DbCheck.databaseName'] ]
                    displayName: Deploy SND2
                    environment: SND2
                    dependsOn: provisioningSND2
                    condition: succeeded()
                    workspace:
                      clean: all
                    strategy:
                      runOnce:
                        deploy:
                          steps:
                            - checkout: self
                            - checkout: FcpPipelineCommon
                            - template: /ado-pipeline/Deploy/deploy.yaml
                              parameters:
                                env: snd2
                                subscription: $(SubscriptionSND2)
                                acr: $(AcrSND)
                                isTemporary: false
                                helm_params: ${{ parameters.snd2_params }}

          - stage: DeploymentDEV
            variables:
              - template: variables.yaml
              - group: fcp-pipeline-dev1-variables
            pool:
              name: 'DEFRA-FFC-DEV1-ubuntu2204'
              condition: succeeded()
            dependsOn:
              - Build
              - Promote
              - DeploymentSND2
            displayName: DEV Deployment

            jobs:
              - job: Create_ServiceNow_Change_Request_prerequisite
                displayName: Change Request Prerequisite
                steps:
                  - checkout: self
                  - checkout: FcpPipelineCommon
                  - template: /ado-pipeline/Deploy/change-request-prerequisite.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)

              - job: Create_ServiceNow_Change_Request
                displayName: Create ServiceNow Change Request
                condition: ${{ eq(parameters.enableServiceNowChangeCreationDev, true) }}
                pool: server
                dependsOn: Create_ServiceNow_Change_Request_prerequisite
                variables:
                  - name: rollbackVersion
                    value: $[ dependencies.Create_ServiceNow_Change_Request_prerequisite.outputs['ExtractVersion.rollbackVersion'] ]
                steps:
                  - template: /ado-pipeline/Deploy/change-request.yaml
                    parameters:
                      sNowConnectionName: $(ServiceNowConnectionDev)
                      rollbackVersion: $(rollbackVersion)
                      upstreamJob: Create_ServiceNow_Change_Request_prerequisite

              - job: provisioningDEV
                displayName: Provisioning DEV
                dependsOn: Create_ServiceNow_Change_Request
                condition: succeeded()
                steps:
                  - checkout: self
                  - checkout: FcpPipelineCommon
                  - template: /ado-pipeline/provision/resources-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                  - template: /ado-pipeline/provision/database-check.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                  - template: /ado-pipeline/provision/database-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/database-migration.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                  - template: /ado-pipeline/provision/database-privileges.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/keyvault-access.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      identityName: $(resourceProvisioning.identityName)

              - deployment: DeployDEV
                variables:
                  - name: identityName
                    value: $[ dependencies.provisioningDEV.outputs['resourceProvisioning.identityName'] ]
                  - name: identityClientId
                    value: $[ dependencies.provisioningDEV.outputs['resourceProvisioning.identityClientId'] ]
                  - name: identityResourceId
                    value: $[ dependencies.provisioningDEV.outputs['resourceProvisioning.identityResourceId'] ]
                  - name: databaseName
                    value: $[ dependencies.provisioningDEV.outputs['DbCheck.databaseName'] ]
                displayName: Deploy DEV
                environment: DEV
                dependsOn:
                  - provisioningDEV
                  - Create_ServiceNow_Change_Request
                condition: succeeded()
                workspace:
                  clean: all
                strategy:
                  runOnce:
                    deploy:
                      steps:
                        - checkout: self
                        - checkout: FcpPipelineCommon
                        - template: /ado-pipeline/Deploy/deploy.yaml
                          parameters:
                            env: dev
                            subscription: $(SubscriptionDEV)
                            acr: $(AcrDEV)
                            isTemporary: false
                            helm_params: ${{ parameters.dev_params }}

          - stage: DeploymentTEST
            variables:
              - template: variables.yaml
              - group: fcp-pipeline-test-variables
            pool:
              name: 'DEFRA-FFC-DEV1-ubuntu2204'
              condition: succeeded()
            dependsOn:
              - Build
              - Promote
              - DeploymentDEV
            displayName: TEST Deployment

            jobs:
              - job: provisioningTEST
                displayName: Provisioning TEST
                condition: succeeded()
                steps:
                  - checkout: self
                  - checkout: FcpPipelineCommon
                  - template: /ado-pipeline/provision/resources-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                  - template: /ado-pipeline/provision/database-check.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                  - template: /ado-pipeline/provision/database-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/database-migration.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                  - template: /ado-pipeline/provision/database-privileges.yaml
                    parameters:
                      subscription: $(SubscriptionDEV)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)

              - deployment: DeployTEST
                variables:
                  - name: identityName
                    value: $[ dependencies.provisioningTEST.outputs['resourceProvisioning.identityName'] ]
                  - name: identityClientId
                    value: $[ dependencies.provisioningTEST.outputs['resourceProvisioning.identityClientId'] ]
                  - name: identityResourceId
                    value: $[ dependencies.provisioningTEST.outputs['resourceProvisioning.identityResourceId'] ]
                  - name: databaseName
                    value: $[ dependencies.provisioningTEST.outputs['DbCheck.databaseName'] ]
                displayName: Deploy TEST
                environment: TEST
                dependsOn: provisioningTEST
                condition: succeeded()
                workspace:
                  clean: all
                strategy:
                  runOnce:
                    deploy:
                      steps:
                        - checkout: self
                        - checkout: FcpPipelineCommon
                        - template: /ado-pipeline/Deploy/deploy.yaml
                          parameters:
                            env: test
                            subscription: $(SubscriptionDEV)
                            acr: $(AcrDEV)
                            isTemporary: false
                            helm_params: ${{ parameters.test_params }}

          - stage: DeploymentPRE
            variables:
              - template: variables.yaml
              - group: fcp-pipeline-pre1-variables
            pool:
              name: 'DEFRA-FFC-PRE1-ubuntu2204'
              condition: succeeded()
            dependsOn:
              - Build
              - Promote
              - DeploymentTEST
            displayName: PRE Deployment

            jobs:
              - job: provisioningPRE
                displayName: Provisioning PRE
                condition: succeeded()
                steps:
                  - checkout: self
                  - checkout: FcpPipelineCommon
                  - template: /ado-pipeline/provision/resources-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                      isTemporary: false
                  - template: /ado-pipeline/provision/database-check.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                  - template: /ado-pipeline/provision/database-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/database-migration.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                  - template: /ado-pipeline/provision/database-privileges.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/keyvault-access.yaml
                    parameters:
                      subscription: $(SubscriptionPRE)
                      identityName: $(resourceProvisioning.identityName)

              - deployment: DeployPRE
                variables:
                  - name: identityName
                    value: $[ dependencies.provisioningPRE.outputs['resourceProvisioning.identityName'] ]
                  - name: identityClientId
                    value: $[ dependencies.provisioningPRE.outputs['resourceProvisioning.identityClientId'] ]
                  - name: identityResourceId
                    value: $[ dependencies.provisioningPRE.outputs['resourceProvisioning.identityResourceId'] ]
                  - name: databaseName
                    value: $[ dependencies.provisioningPRE.outputs['DbCheck.databaseName'] ]
                displayName: Deploy PRE
                environment: PRE
                dependsOn: provisioningPRE
                condition: succeeded()
                workspace:
                  clean: all
                strategy:
                  runOnce:
                    deploy:
                      steps:
                        - checkout: self
                        - checkout: FcpPipelineCommon
                        - template: /ado-pipeline/Deploy/deploy.yaml
                          parameters:
                            env: pre
                            subscription: $(SubscriptionPRE)
                            acr: $(AcrPRE)
                            isTemporary: false
                            helm_params: ${{ parameters.pre_params }}

          - stage: DeploymentPRD
            variables:
              - template: variables.yaml
              - group: fcp-pipeline-prd1-variables
            pool:
              name: 'DEFRA-FFC-PRD1-ubuntu2204'
              condition: succeeded()
            dependsOn:
              - Build
              - Promote
              - DeploymentPRE
            displayName: PRD Deployment

            jobs:
              - job: Create_ServiceNow_Change_Request_prerequisite
                displayName: Change Request Prerequisite
                steps:
                  - checkout: self
                  - checkout: FcpPipelineCommon
                  - template: /ado-pipeline/Deploy/change-request-prerequisite.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)

              - job: Create_ServiceNow_Change_Request
                displayName: Create ServiceNow Change Request
                condition: ${{ eq(parameters.enableServiceNowChangeCreation, true) }}
                pool: server
                dependsOn: Create_ServiceNow_Change_Request_prerequisite
                variables:
                  - name: rollbackVersion
                    value: $[ dependencies.Create_ServiceNow_Change_Request_prerequisite.outputs['ExtractVersion.rollbackVersion'] ]
                steps:
                  - template: /ado-pipeline/Deploy/change-request.yaml
                    parameters:
                      sNowConnectionName: $(ServiceNowConnection)
                      rollbackVersion: $(rollbackVersion)
                      upstreamJob: Create_ServiceNow_Change_Request_prerequisite

              - job: provisioningPRD
                displayName: Provisioning PRD
                dependsOn: Create_ServiceNow_Change_Request
                condition: succeeded()
                steps:
                  - checkout: self
                  - checkout: FcpPipelineCommon
                  - template: /ado-pipeline/provision/resources-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                      isTemporary: false
                  - template: /ado-pipeline/provision/database-check.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                  - template: /ado-pipeline/provision/database-provisioning.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/database-migration.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                  - template: /ado-pipeline/provision/database-privileges.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                      isTemporary: false
                      databaseName: $(DbCheck.databaseName)
                      identityName: $(resourceProvisioning.identityName)
                  - template: /ado-pipeline/provision/keyvault-access.yaml
                    parameters:
                      subscription: $(SubscriptionPRD)
                      identityName: $(resourceProvisioning.identityName)

              - deployment: DeployPRD
                variables:
                  - name: identityName
                    value: $[ dependencies.provisioningPRD.outputs['resourceProvisioning.identityName'] ]
                  - name: identityClientId
                    value: $[ dependencies.provisioningPRD.outputs['resourceProvisioning.identityClientId'] ]
                  - name: identityResourceId
                    value: $[ dependencies.provisioningPRD.outputs['resourceProvisioning.identityResourceId'] ]
                  - name: databaseName
                    value: $[ dependencies.provisioningPRD.outputs['DbCheck.databaseName'] ]
                displayName: Deploy PRD
                environment: PRD
                dependsOn:
                  - provisioningPRD
                  - Create_ServiceNow_Change_Request
                condition: succeeded()
                workspace:
                  clean: all
                strategy:
                  runOnce:
                    deploy:
                      steps:
                        - checkout: self
                        - checkout: FcpPipelineCommon
                        - template: /ado-pipeline/Deploy/deploy.yaml
                          parameters:
                            env: prd
                            subscription: $(SubscriptionPRD)
                            acr: $(AcrPRD)
                            isTemporary: false
                            helm_params: ${{ parameters.prd_params }}
